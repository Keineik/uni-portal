ALTER SESSION SET "_ORACLE_SCRIPT"=true;

-- Xóa các cấu trúc dữ liệu nếu tồn tại
BEGIN 
    -- Xóa các user và schema
    FOR usr IN (SELECT * FROM ALL_USERS WHERE USERNAME IN ('QLDaiHoc', 'QLDAIHOC')) LOOP
        -- Ngắt kết nối của user
        FOR ses IN (SELECT SID, SERIAL# FROM V$SESSION WHERE USERNAME = usr.USERNAME) LOOP
            EXECUTE IMMEDIATE 'ALTER SYSTEM KILL SESSION ''' || ses.SID || ',' || ses.SERIAL# || ''' IMMEDIATE';
        END LOOP;
        -- Xóa user
        EXECUTE IMMEDIATE 'DROP USER "' || usr.USERNAME || '" CASCADE';
    END LOOP;

    -- Xóa các role
    FOR rle IN (SELECT * FROM DBA_ROLES WHERE ROLE LIKE 'RL_%') LOOP
        EXECUTE IMMEDIATE 'DROP ROLE "' || rle.ROLE || '"';
    END LOOP;
END;
/

-- Tạo quan hệ và các bảng
CREATE USER "QLDAIHOC" IDENTIFIED BY "Nhom01";
GRANT ALL PRIVILEGES TO "QLDAIHOC";
ALTER SESSION SET CURRENT_SCHEMA = "QLDAIHOC";

CREATE TABLE DONVI (
    MADV NVARCHAR2(15) PRIMARY KEY,
    TENDV NVARCHAR2(127) NOT NULL UNIQUE,
    LOAIDV NVARCHAR2(7) CHECK (LOAIDV IN ('Khoa', 'Phòng')),
    TRGDV NVARCHAR2(15),
    COSO NVARCHAR2(7) CHECK (COSO IN ('CS1', 'CS2'))
);

CREATE TABLE NHANVIEN (
    MANV NVARCHAR2(15) PRIMARY KEY,
    HOTEN NVARCHAR2(127) NOT NULL,
    PHAI NVARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    LUONG NUMBER(19, 4) CHECK (LUONG >= 0),
    PHUCAP NUMBER(19, 4) CHECK (PHUCAP >= 0),
    DT NVARCHAR2(15) UNIQUE,
    VAITRO NVARCHAR2(15) CHECK (VAITRO IN ('NVCB', 'GV', 'NV_PDT', 'NV_PKT', 'NV_TCHC', 'NV_CTSV', 'TRGDV')),
    MADV NVARCHAR2(15),
    COSO NVARCHAR2(7) CHECK (COSO IN ('CS1', 'CS2')),

    CONSTRAINT FK_NHANVIEN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);
-- Tạo ràng buộc khóa ngoại cho trưởng đơn vị
ALTER TABLE DONVI ADD CONSTRAINT 
    FK_DONVI_NHANVIEN FOREIGN KEY (TRGDV) REFERENCES NHANVIEN(MANV) ON DELETE SET NULL;

-- Tạo ID tự động cho bảng NHANVIEN
CREATE SEQUENCE USEQ_NHANVIEN_MANV INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_NHANVIEN_AUTOKEY
BEFORE INSERT ON NHANVIEN
FOR EACH ROW
BEGIN
    -- Tạo mã nhân viên tự động theo định dạng NV00000001, NV00000002,...
    SELECT 'NV' || TRIM(TO_CHAR(USEQ_NHANVIEN_MANV.NEXTVAL, '00000000')) INTO :NEW.MANV FROM DUAL;
END;
/

CREATE TABLE SINHVIEN (
    MASV NVARCHAR2(15) PRIMARY KEY,
    HOTEN NVARCHAR2(127) NOT NULL,
    PHAI NVARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    DCHI NVARCHAR2(255),
    DT NVARCHAR2(15) UNIQUE,
    KHOA NVARCHAR2(50),
    TINHTRANG NVARCHAR2(15) CHECK (TINHTRANG IN ('Đang học', 'Nghỉ học', 'Bảo lưu', 'Đã tốt nghiệp')),
    COSO NVARCHAR2(7) CHECK (COSO IN ('CS1', 'CS2')),

    CONSTRAINT FK_SINHVIEN_DONVI FOREIGN KEY (KHOA) REFERENCES DONVI(MADV)
);
-- Tạo ID tự động cho bảng SINHVIEN
CREATE SEQUENCE USEQ_SINHVIEN_MASV INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_SINHVIEN_AUTOKEY
BEFORE INSERT ON SINHVIEN 
FOR EACH ROW
BEGIN
    -- Tạo mã sinh viên tự động theo định dạng SV00000001, SV00000002,...
    SELECT 'SV' || TRIM(TO_CHAR(USEQ_SINHVIEN_MASV.NEXTVAL, '00000000')) INTO :NEW.MASV FROM DUAL;
END;
/

CREATE TABLE HOCPHAN (
    MAHP NVARCHAR2(15) PRIMARY KEY,
    TENHP NVARCHAR2(127) NOT NULL,
    SOTC NUMBER(3) CHECK (SOTC > 0),
    STLT NUMBER(3) CHECK (STLT >= 0),
    STTH NUMBER(3) CHECK (STTH >= 0),
    MADV NVARCHAR2(15),

    CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

CREATE TABLE MOMON (
    MAMM NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    MAHP NVARCHAR2(15),
    MAGV NVARCHAR2(15),
    HK NUMBER(2) CHECK (HK IN (1, 2, 3)),
    NAM NUMBER(4) CHECK (NAM >= 1900 AND NAM <= 9999),

    CONSTRAINT FK_MOMON_HOCPHAN FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP),
    CONSTRAINT FK_MOMON_NHANVIEN FOREIGN KEY (MAGV) REFERENCES NHANVIEN(MANV)
);

CREATE TABLE DANGKY (
    MASV NVARCHAR2(15),
    MAMM NUMBER,
    DIEMTH NUMBER(5, 2) CHECK (DIEMTH >= 0 AND DIEMTH <= 10),
    DIEMQT NUMBER(5, 2) CHECK (DIEMQT >= 0 AND DIEMQT <= 10),
    DIEMTHI NUMBER(5, 2) CHECK (DIEMTHI >= 0 AND DIEMTHI <= 10),
    DIEMTK NUMBER(5, 2) CHECK (DIEMTK >= 0 AND DIEMTK <= 10),

    CONSTRAINT PK_DANGKY PRIMARY KEY (MASV, MAMM),
    CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    CONSTRAINT FK_DANGKY_MOMON FOREIGN KEY (MAMM) REFERENCES MOMON(MAMM)
);

CREATE TABLE THONGBAO (
    MATB NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    NOIDUNG NVARCHAR2(255) NOT NULL
);

-- Sửa lại phần INSERT dữ liệu mẫu cho DONVI để phân theo cơ sở
BEGIN
    -- Insert dữ liệu vào bảng DONVI phân theo cơ sở
    -- Khoa Toán tại 2 cơ sở
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('TOAN_CS1', 'Khoa Toán Tin - Cơ sở 1', 'Khoa', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('TOAN_CS2', 'Khoa Toán Tin - Cơ sở 2', 'Khoa', NULL, 'CS2');
    
    -- Khoa Hóa tại 2 cơ sở
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('HOA_CS1', 'Khoa Hóa học - Cơ sở 1', 'Khoa', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('HOA_CS2', 'Khoa Hóa học - Cơ sở 2', 'Khoa', NULL, 'CS2');
    
    -- Khoa Lý tại 2 cơ sở
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('LY_CS1', 'Khoa Vật lý - Cơ sở 1', 'Khoa', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('LY_CS2', 'Khoa Vật lý - Cơ sở 2', 'Khoa', NULL, 'CS2');
    
    -- Các phòng ban hành chính (giả sử chỉ có ở CS1)
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('PDT_CS1', 'Phòng Đào tạo - Cơ sở 1', 'Phòng', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('PKT_CS1', 'Phòng Khảo thí - Cơ sở 1', 'Phòng', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('TCHC_CS1', 'Phòng Tổ chức hành chính - Cơ sở 1', 'Phòng', NULL, 'CS1');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('CTSV_CS1', 'Phòng Công tác sinh viên - Cơ sở 1', 'Phòng', NULL, 'CS1');
    
    -- Các phòng ban hành chính (giả sử cũng có ở CS2)
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('PDT_CS2', 'Phòng Đào tạo - Cơ sở 2', 'Phòng', NULL, 'CS2');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('PKT_CS2', 'Phòng Khảo thí - Cơ sở 2', 'Phòng', NULL, 'CS2');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('TCHC_CS2', 'Phòng Tổ chức hành chính - Cơ sở 2', 'Phòng', NULL, 'CS2');
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV, COSO) VALUES ('CTSV_CS2', 'Phòng Công tác sinh viên - Cơ sở 2', 'Phòng', NULL, 'CS2');
    
    COMMIT;

    -- Insert dữ liệu vào bảng NHANVIEN
    -- Nhân viên ở cơ sở 1
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Văn A', 'Nam', TO_DATE('1990-01-01', 'YYYY-MM-DD'), 10000, 2000, '0123456789', 'TRGDV', 'TOAN_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Trần Văn B', 'Nam', TO_DATE('1991-02-02', 'YYYY-MM-DD'), 12000, 2500, '0987654322', 'GV', 'TOAN_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Thị C', 'Nữ', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '01234567892', 'GV', 'TOAN_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Văn B', 'Nam', TO_DATE('1991-02-02', 'YYYY-MM-DD'), 12000, 2500, '0987654323', 'TRGDV', 'HOA_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Đinh Văn C', 'Nam', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456712', 'GV', 'HOA_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Lê Thị C', 'Nữ', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456786', 'TRGDV', 'LY_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Đình C', 'Nam', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456783', 'GV', 'LY_CS1', 'CS1');
    
    -- Nhân viên ở cơ sở 2
    INSERT INTO NHANVIEN VALUES (NULL, 'Trần Thị D', 'Nữ', TO_DATE('1990-02-15', 'YYYY-MM-DD'), 10200, 2100, '0123456790', 'TRGDV', 'TOAN_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Lê Văn E', 'Nam', TO_DATE('1991-03-12', 'YYYY-MM-DD'), 12200, 2550, '0987654332', 'GV', 'TOAN_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Phạm Thị F', 'Nữ', TO_DATE('1992-04-23', 'YYYY-MM-DD'), 11200, 3100, '01234567893', 'GV', 'TOAN_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Trần Văn G', 'Nam', TO_DATE('1991-05-22', 'YYYY-MM-DD'), 12100, 2600, '0987654333', 'TRGDV', 'HOA_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Hoàng Văn H', 'Nam', TO_DATE('1992-06-13', 'YYYY-MM-DD'), 11100, 3200, '0123456713', 'GV', 'HOA_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Thị I', 'Nữ', TO_DATE('1992-07-04', 'YYYY-MM-DD'), 11100, 3100, '0123456787', 'TRGDV', 'LY_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Phan Đình K', 'Nam', TO_DATE('1992-08-08', 'YYYY-MM-DD'), 11100, 3100, '0123456784', 'GV', 'LY_CS2', 'CS2');

    -- Nhân viên phòng ban ở cơ sở 1
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Xuân D', 'Nam', TO_DATE('1993-04-04', 'YYYY-MM-DD'), 13000, 3500, '0987654324', 'NV_PDT', 'PDT_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Trịnh Văn E', 'Nam', TO_DATE('1994-05-05', 'YYYY-MM-DD'), 14000, 4000, '0123456785', 'NV_PKT', 'PKT_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Đậu Bách F', 'Nam', TO_DATE('1995-06-06', 'YYYY-MM-DD'), 15000, 4500, '0987654321', 'NV_TCHC', 'TCHC_CS1', 'CS1');
    INSERT INTO NHANVIEN VALUES (NULL, 'Lê Mai B', 'Nữ', TO_DATE('1996-07-07', 'YYYY-MM-DD'), 16000, 5000, '0123456788', 'NV_CTSV', 'CTSV_CS1', 'CS1');

    -- Nhân viên phòng ban ở cơ sở 2
    -- Nhân viên phòng ban ở cơ sở 2
    INSERT INTO NHANVIEN VALUES (NULL, 'Võ Minh L', 'Nam', TO_DATE('1993-09-14', 'YYYY-MM-DD'), 13200, 3600, '0987654325', 'NV_PDT', 'PDT_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Đặng Văn M', 'Nam', TO_DATE('1994-10-15', 'YYYY-MM-DD'), 14200, 4100, '0123456799', 'NV_PKT', 'PKT_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Hồ Thị N', 'Nữ', TO_DATE('1995-11-16', 'YYYY-MM-DD'), 15200, 4600, '0987654326', 'NV_TCHC', 'TCHC_CS2', 'CS2');
    INSERT INTO NHANVIEN VALUES (NULL, 'Ngô Hoàng P', 'Nam', TO_DATE('1996-12-17', 'YYYY-MM-DD'), 16200, 5100, '0123456791', 'NV_CTSV', 'CTSV_CS2', 'CS2');
    
    COMMIT;

    -- Cập nhật trưởng đơn vị cho các đơn vị
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456789') WHERE MADV = 'TOAN_CS1';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0987654323') WHERE MADV = 'HOA_CS1';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456786') WHERE MADV = 'LY_CS1';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456790') WHERE MADV = 'TOAN_CS2';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0987654333') WHERE MADV = 'HOA_CS2';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456787') WHERE MADV = 'LY_CS2';
    COMMIT;

    -- Insert dữ liệu vào bảng SINHVIEN
    -- Sinh viên ở cơ sở 1
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn G', 'Nam', TO_DATE('2000-01-01', 'YYYY-MM-DD'), 'TP HCM', '0123456792', 'TOAN_CS1', 'Đang học', 'CS1');
    INSERT INTO SINHVIEN VALUES (NULL, 'Trần Văn H', 'Nam', TO_DATE('2001-02-02', 'YYYY-MM-DD'), 'TP HCM', '0987654327', 'HOA_CS1', 'Đang học', 'CS1');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Thị I', 'Nữ', TO_DATE('2002-03-03', 'YYYY-MM-DD'), 'TP HCM', '0123456793', 'LY_CS1', 'Đang học', 'CS1');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn K', 'Nam', TO_DATE('2003-04-04', 'YYYY-MM-DD'), 'TP HCM', '0987654328', 'TOAN_CS1', 'Đang học', 'CS1');
    
    -- Sinh viên ở cơ sở 2
    INSERT INTO SINHVIEN VALUES (NULL, 'Đinh Văn L', 'Nam', TO_DATE('2004-05-05', 'YYYY-MM-DD'), 'TP HCM', '0123456794', 'HOA_CS2', 'Đang học', 'CS2');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn J', 'Nam', TO_DATE('2003-04-04', 'YYYY-MM-DD'), 'TP HCM', '0987654329', 'TOAN_CS2', 'Nghỉ học', 'CS2');
    INSERT INTO SINHVIEN VALUES (NULL, 'Đinh Văn K', 'Nam', TO_DATE('2004-05-05', 'YYYY-MM-DD'), 'TP HCM', '0123456795', 'HOA_CS2', 'Bảo lưu', 'CS2');
    INSERT INTO SINHVIEN VALUES (NULL, 'Lê Thị L', 'Nữ', TO_DATE('2005-06-06', 'YYYY-MM-DD'), 'TP HCM', '0123456796', 'LY_CS2', 'Đã tốt nghiệp', 'CS2');
    COMMIT;

    -- Insert dữ liệu vào bảng HOCPHAN
    -- Học phần của khoa Toán
    INSERT INTO HOCPHAN VALUES ('MTH0001_CS1', 'Giải tích 1 - CS1', 4, 3, 1, 'TOAN_CS1');
    INSERT INTO HOCPHAN VALUES ('MTH0002_CS1', 'Giải tích 2 - CS1', 4, 3, 1, 'TOAN_CS1');
    INSERT INTO HOCPHAN VALUES ('MTH0003_CS1', 'Đại số tuyến tính - CS1', 4, 3, 1, 'TOAN_CS1');
    INSERT INTO HOCPHAN VALUES ('MTH0001_CS2', 'Giải tích 1 - CS2', 4, 3, 1, 'TOAN_CS2');
    INSERT INTO HOCPHAN VALUES ('MTH0002_CS2', 'Giải tích 2 - CS2', 4, 3, 1, 'TOAN_CS2');
    INSERT INTO HOCPHAN VALUES ('MTH0003_CS2', 'Đại số tuyến tính - CS2', 4, 3, 1, 'TOAN_CS2');
    
    -- Học phần của khoa Hóa
    INSERT INTO HOCPHAN VALUES ('CHE0001_CS1', 'Hóa đại cương - CS1', 4, 3, 1, 'HOA_CS1');
    INSERT INTO HOCPHAN VALUES ('CHE0002_CS1', 'Hóa hữu cơ - CS1', 4, 3, 1, 'HOA_CS1');
    INSERT INTO HOCPHAN VALUES ('CHE0001_CS2', 'Hóa đại cương - CS2', 4, 3, 1, 'HOA_CS2');
    INSERT INTO HOCPHAN VALUES ('CHE0002_CS2', 'Hóa hữu cơ - CS2', 4, 3, 1, 'HOA_CS2');
    
    -- Học phần của khoa Lý
    INSERT INTO HOCPHAN VALUES ('PHY0001_CS1', 'Vật lý đại cương - CS1', 4, 3, 1, 'LY_CS1');
    INSERT INTO HOCPHAN VALUES ('PHY0002_CS1', 'Vật lý điện từ - CS1', 4, 3, 1, 'LY_CS1');
    INSERT INTO HOCPHAN VALUES ('PHY0003_CS1', 'Vật lý quang học - CS1', 4, 3, 1, 'LY_CS1');
    INSERT INTO HOCPHAN VALUES ('PHY0001_CS2', 'Vật lý đại cương - CS2', 4, 3, 1, 'LY_CS2');
    INSERT INTO HOCPHAN VALUES ('PHY0002_CS2', 'Vật lý điện từ - CS2', 4, 3, 1, 'LY_CS2');
    INSERT INTO HOCPHAN VALUES ('PHY0003_CS2', 'Vật lý quang học - CS2', 4, 3, 1, 'LY_CS2');
    COMMIT;

    -- Insert dữ liệu vào bảng MOMON
    FOR hp IN (SELECT * FROM HOCPHAN) LOOP
        FOR gv IN (SELECT * FROM NHANVIEN WHERE VAITRO = 'GV' AND MADV = hp.MADV) LOOP
            INSERT INTO MOMON (MAHP, MAGV, HK, NAM) VALUES (hp.MAHP, gv.MANV, TO_NUMBER(SUBSTR(hp.MAHP, 7, 1)), 2024);
        END LOOP;
    END LOOP;
    COMMIT;

    -- Insert dữ liệu vào bảng DANGKY
    FOR sv IN (SELECT * FROM SINHVIEN) LOOP
        -- Chỉ đăng ký các môn cùng cơ sở với sinh viên
        FOR mon IN (SELECT m.*, h.MADV 
                    FROM MOMON m 
                    JOIN HOCPHAN h ON m.MAHP = h.MAHP
                    WHERE SUBSTR(h.MADV, -3) = sv.COSO) LOOP
            -- Random điểm TH, QT, THI nếu là hk1 hoặc 2
            IF mon.HK IN (1, 2) THEN
                INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMTHI, DIEMTK)
                VALUES (sv.MASV, mon.MAMM, ROUND(DBMS_RANDOM.VALUE(3, 10), 0), 
                        ROUND(DBMS_RANDOM.VALUE(3, 10), 0), 
                        ROUND(DBMS_RANDOM.VALUE(3, 10), 0), NULL);
                -- Cập nhật điểm tổng kết theo tỉ lệ 30% TH + 20% QT + 50% THI
                UPDATE DANGKY SET DIEMTK = ROUND(DIEMTH * 0.3 + DIEMQT * 0.2 + DIEMTHI * 0.5, 2)
                WHERE MASV = sv.MASV AND MAMM = mon.MAMM;
            -- Coi như chưa có điểm nếu là hk3
            ELSE 
                INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMTHI, DIEMTK) 
                VALUES (sv.MASV, mon.MAMM, NULL, NULL, NULL, NULL);
            END IF;
        END LOOP;
    END LOOP;
    COMMIT;
END;
/

-- Kiểm tra dữ liệu đã được insert thành công hay chưa
SELECT * FROM DONVI;
SELECT * FROM NHANVIEN;
SELECT * FROM SINHVIEN;
SELECT * FROM HOCPHAN;
SELECT * FROM MOMON;
SELECT * FROM DANGKY;
SELECT * FROM THONGBAO;