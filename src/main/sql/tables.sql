ALTER SESSION SET "_ORACLE_SCRIPT"=true;

-- Xóa các cấu trúc dữ liệu nếu tồn tại
BEGIN 
    -- Xóa các user và schema
    FOR usr IN (SELECT * FROM ALL_USERS WHERE USERNAME IN ('QLDaiHoc', 'QLDAIHOC')) LOOP
        -- Ngắt kết nối của user
        FOR ses IN (SELECT SID, SERIAL# FROM V$SESSION WHERE USERNAME = usr.USERNAME) LOOP
            EXECUTE IMMEDIATE 'ALTER SYSTEM KILL SESSION ''' || ses.SID || ',' || ses.SERIAL# || ''' IMMEDIATE';
        END LOOP;
        -- Xóa user
        EXECUTE IMMEDIATE 'DROP USER "' || usr.USERNAME || '" CASCADE';
    END LOOP;

    -- Xóa các role
    FOR rle IN (SELECT * FROM DBA_ROLES WHERE ROLE LIKE 'RL_%') LOOP
        EXECUTE IMMEDIATE 'DROP ROLE "' || rle.ROLE || '"';
    END LOOP;
END;
/

-- Tạo quan hệ và các bảng
CREATE USER "QLDAIHOC" IDENTIFIED BY "Nhom01";
GRANT ALL PRIVILEGES TO "QLDAIHOC";
ALTER SESSION SET CURRENT_SCHEMA = "QLDAIHOC";

CREATE TABLE DONVI (
    MADV NVARCHAR2(15) PRIMARY KEY,
    TENDV NVARCHAR2(127) NOT NULL UNIQUE,
    LOAIDV NVARCHAR2(7) CHECK (LOAIDV IN ('Khoa', 'Phòng')),
    TRGDV NVARCHAR2(15)
);

CREATE TABLE NHANVIEN (
    MANV NVARCHAR2(15) PRIMARY KEY,
    HOTEN NVARCHAR2(127) NOT NULL,
    PHAI NVARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    LUONG NUMBER(19, 4) CHECK (LUONG >= 0),
    PHUCAP NUMBER(19, 4) CHECK (PHUCAP >= 0),
    DT NVARCHAR2(15) UNIQUE,
    VAITRO NVARCHAR2(15) CHECK (VAITRO IN ('NVCB', 'GV', 'NV_PDT', 'NV_PKT', 'NV_TCHC', 'NV_CTSV', 'TRGDV')),
    MADV NVARCHAR2(15),

    CONSTRAINT FK_NHANVIEN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);
-- Tạo ràng buộc khóa ngoại cho trưởng đơn vị
ALTER TABLE DONVI ADD CONSTRAINT 
    FK_DONVI_NHANVIEN FOREIGN KEY (TRGDV) REFERENCES NHANVIEN(MANV) ON DELETE SET NULL;

-- Tạo ID tự động cho bảng NHANVIEN
-- Tạo ID tự động cho bảng SINHVIEN
CREATE SEQUENCE USEQ_NHANVIEN_MANV INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_NHANVIEN_AUTOKEY
BEFORE INSERT ON NHANVIEN
FOR EACH ROW
BEGIN
    -- Tạo mã sinh viên tự động theo định dạng NV00000001, NV00000002,...
    SELECT 'NV' || TRIM(TO_CHAR(USEQ_NHANVIEN_MANV.NEXTVAL, '00000000')) INTO :NEW.MANV FROM DUAL;
END;
/

CREATE TABLE SINHVIEN (
    MASV NVARCHAR2(15) PRIMARY KEY,
    HOTEN NVARCHAR2(127) NOT NULL,
    PHAI NVARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    DCHI NVARCHAR2(255),
    DT NVARCHAR2(15) UNIQUE,
    KHOA NVARCHAR2(15),
    TINHTRANG NVARCHAR2(15) CHECK (TINHTRANG IN ('Đang học', 'Nghỉ học', 'Bảo lưu', 'Đã tốt nghiệp')),

    CONSTRAINT FK_SINHVIEN_DONVI FOREIGN KEY (KHOA) REFERENCES DONVI(MADV)
);
-- Tạo ID tự động cho bảng SINHVIEN
CREATE SEQUENCE USEQ_SINHVIEN_MASV INCREMENT BY 1 START WITH 1 NOCACHE NOCYCLE;
CREATE OR REPLACE TRIGGER TRG_SINHVIEN_AUTOKEY
BEFORE INSERT ON SINHVIEN 
FOR EACH ROW
BEGIN
    -- Tạo mã sinh viên tự động theo định dạng SV00000001, SV00000002,...
    SELECT 'SV' || TRIM(TO_CHAR(USEQ_SINHVIEN_MASV.NEXTVAL, '00000000')) INTO :NEW.MASV FROM DUAL;
END;
/

CREATE TABLE HOCPHAN (
    MAHP NVARCHAR2(15) PRIMARY KEY,
    TENHP NVARCHAR2(127) NOT NULL,
    SOTC NUMBER(3) CHECK (SOTC > 0),
    STLT NUMBER(3) CHECK (STLT >= 0),
    STTH NUMBER(3) CHECK (STTH >= 0),
    MADV NVARCHAR2(15),

    CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

CREATE TABLE MOMON (
    MAMM NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    MAHP NVARCHAR2(15),
    MAGV NVARCHAR2(15),
    HK NUMBER(2) CHECK (HK IN (1, 2, 3)),
    NAM NUMBER(4) CHECK (NAM >= 1900 AND NAM <= 9999),

    CONSTRAINT FK_MOMON_HOCPHAN FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP),
    CONSTRAINT FK_MOMON_NHANVIEN FOREIGN KEY (MAGV) REFERENCES NHANVIEN(MANV)
);

CREATE TABLE DANGKY (
    MASV NVARCHAR2(15),
    MAMM NUMBER,
    DIEMTH NUMBER(5, 2) CHECK (DIEMTH >= 0 AND DIEMTH <= 10),
    DIEMQT NUMBER(5, 2) CHECK (DIEMQT >= 0 AND DIEMQT <= 10),
    DIEMTHI NUMBER(5, 2) CHECK (DIEMTHI >= 0 AND DIEMTHI <= 10),
    DIEMTK NUMBER(5, 2) CHECK (DIEMTK >= 0 AND DIEMTK <= 10),

    CONSTRAINT PK_DANGKY PRIMARY KEY (MASV, MAMM),
    CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    CONSTRAINT FK_DANGKY_MOMON FOREIGN KEY (MAMM) REFERENCES MOMON(MAMM)
);

CREATE TABLE THONGBAO (
    MATB NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    NOIDUNG NVARCHAR2(255) NOT NULL
);

-- Insert dữ liệu mẫu
BEGIN
    -- Insert dữ liệu vào bảng DONVI
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('TOAN', 'Khoa Toán Tin', 'Khoa', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('HOA', 'Khoa Hóa học', 'Khoa', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('LY', 'Khoa Vật lý', 'Khoa', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('PDT', 'Phòng Đào tạo', 'Phòng', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('PKT', 'Phòng Khảo thí', 'Phòng', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('TCHC', 'Phòng Tổ chức hành chính', 'Phòng', NULL);
    INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('CTSV', 'Phòng Công tác sinh viên', 'Phòng', NULL);
    COMMIT;

    -- Insert dữ liệu vào bảng NHANVIEN
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Văn A', 'Nam', TO_DATE('1990-01-01', 'YYYY-MM-DD'), 10000, 2000, '0123456789', 'TRGDV', 'TOAN');
    INSERT INTO NHANVIEN VALUES (NULL, 'Trần Văn B', 'Nam', TO_DATE('1991-02-02', 'YYYY-MM-DD'), 12000, 2500, '0987654322', 'GV', 'TOAN');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Thị C', 'Nữ', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '01234567892', 'GV', 'TOAN');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Văn B', 'Nam', TO_DATE('1991-02-02', 'YYYY-MM-DD'), 12000, 2500, '0987654323', 'TRGDV', 'HOA');
    INSERT INTO NHANVIEN VALUES (NULL, 'Đinh Văn C', 'Nam', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456712', 'GV', 'HOA');
    INSERT INTO NHANVIEN VALUES (NULL, 'Lê Thị C', 'Nữ', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456786', 'TRGDV', 'LY');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Đình C', 'Nam', TO_DATE('1992-03-03', 'YYYY-MM-DD'), 11000, 3000, '0123456783', 'GV', 'LY');
    INSERT INTO NHANVIEN VALUES (NULL, 'Nguyễn Xuân D', 'Nam', TO_DATE('1993-04-04', 'YYYY-MM-DD'), 13000, 3500, '0987654324', 'NV_PDT', 'PDT');
    INSERT INTO NHANVIEN VALUES (NULL, 'Trịnh Văn E', 'Nam', TO_DATE('1994-05-05', 'YYYY-MM-DD'), 14000, 4000, '0123456784', 'NV_PKT', 'PKT');
    INSERT INTO NHANVIEN VALUES (NULL, 'Đậu Bách F', 'Nam', TO_DATE('1995-06-06', 'YYYY-MM-DD'), 15000, 4500, '0987654321', 'NV_TCHC', 'TCHC');
    INSERT INTO NHANVIEN VALUES (NULL, 'Lê Mai B', 'Nữ', TO_DATE('1996-07-07', 'YYYY-MM-DD'), 16000, 5000, '0123456785', 'NV_CTSV', 'CTSV');
    COMMIT;
    -- Cập nhật trưởng đơn vị cho các đơn vị
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456789') WHERE MADV = 'TOAN';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0987654323') WHERE MADV = 'HOA';
    UPDATE DONVI SET TRGDV = (SELECT MANV FROM NHANVIEN WHERE DT = '0123456786') WHERE MADV = 'LY';
    COMMIT;

    -- Insert dữ liệu vào bảng SINHVIEN
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn G', 'Nam', TO_DATE('2000-01-01', 'YYYY-MM-DD'), 'TP HCM', '0123456789', 'TOAN', 'Đang học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Trần Văn H', 'Nam', TO_DATE('2001-02-02', 'YYYY-MM-DD'), 'TP HCM', '0987654322', 'HOA', 'Đang học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Thị I', 'Nữ', TO_DATE('2002-03-03', 'YYYY-MM-DD'), 'TP HCM', '0123456712', 'LY', 'Đang học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn K', 'Nam', TO_DATE('2003-04-04', 'YYYY-MM-DD'), 'TP HCM', '0987654323', 'TOAN', 'Đang học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Đinh Văn L', 'Nam', TO_DATE('2004-05-05', 'YYYY-MM-DD'), 'TP HCM', '0123456784', 'HOA', 'Đang học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Nguyễn Văn J', 'Nam', TO_DATE('2003-04-04', 'YYYY-MM-DD'), 'TP HCM', '0987654321', 'TOAN', 'Nghỉ học');
    INSERT INTO SINHVIEN VALUES (NULL, 'Đinh Văn K', 'Nam', TO_DATE('2004-05-05', 'YYYY-MM-DD'), 'TP HCM', '0123456783', 'HOA', 'Bảo lưu');
    INSERT INTO SINHVIEN VALUES (NULL, 'Lê Thị L', 'Nữ', TO_DATE('2005-06-06', 'YYYY-MM-DD'), 'TP HCM', '0123456785', 'LY', 'Đã tốt nghiệp');
    COMMIT;

    -- Insert dữ liệu vào bảng HOCPHAN
    INSERT INTO HOCPHAN VALUES ('MTH0001', 'Giải tích 1', 4, 3, 1, 'TOAN');
    INSERT INTO HOCPHAN VALUES ('MTH0002', 'Giải tích 2', 4, 3, 1, 'TOAN');
    INSERT INTO HOCPHAN VALUES ('MTH0003', 'Đại số tuyến tính', 4, 3, 1, 'TOAN');
    INSERT INTO HOCPHAN VALUES ('CHE0001', 'Hóa đại cương', 4, 3, 1, 'HOA');
    INSERT INTO HOCPHAN VALUES ('CHE0002', 'Hóa hữu cơ', 4, 3, 1, 'HOA');
    INSERT INTO HOCPHAN VALUES ('PHY0001', 'Vật lý đại cương', 4, 3, 1, 'LY');
    INSERT INTO HOCPHAN VALUES ('PHY0002', 'Vật lý điện từ', 4, 3, 1, 'LY');
    INSERT INTO HOCPHAN VALUES ('PHY0003', 'Vật lý quang học', 4, 3, 1, 'LY');
    COMMIT;

    -- Insert dữ liệu vào bảng MOMON
    FOR hp IN (SELECT * FROM HOCPHAN) LOOP
        FOR gv IN (SELECT * FROM NHANVIEN WHERE VAITRO = 'GV' AND MADV = hp.MADV) LOOP
            INSERT INTO MOMON (MAHP, MAGV, HK, NAM) VALUES (hp.MAHP, gv.MANV, TO_NUMBER(SUBSTR(hp.MAHP, -1)), 2024);
        END LOOP;
    END LOOP;
    COMMIT;

    -- Insert dữ liệu vào bảng DANGKY
    FOR sv IN (SELECT * FROM SINHVIEN) LOOP
        FOR mon IN (SELECT * FROM MOMON) LOOP
            -- Random điểm TH, QT, THI nếu là hk1 hoặc 2
            IF mon.HK IN (1, 2) THEN
                INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMTHI, DIEMTK)
                VALUES (sv.MASV, mon.MAMM, ROUND(DBMS_RANDOM.VALUE(3, 10), 0), ROUND(DBMS_RANDOM.VALUE(3, 10), 0), ROUND(DBMS_RANDOM.VALUE(3, 10), 0), NULL);
                -- Cập nhật điểm tổng kết theo tỉ lệ 30% TH + 20% QT + 50% THI
                UPDATE DANGKY SET DIEMTK = ROUND(DIEMTH * 0.3 + DIEMQT * 0.2 + DIEMTHI * 0.5, 2)
                WHERE MASV = sv.MASV AND MAMM = mon.MAMM;
            -- Coi chưa chưa có điểm nếu là hk3
            ELSE 
                INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMTHI, DIEMTK) 
                VALUES (sv.MASV, mon.MAMM, NULL, NULL, NULL, NULL);
            END IF;
        END LOOP;
    END LOOP;
    COMMIT;
END;
/

-- Kiểm tra dữ liệu đã được insert thành công hay chưa
SELECT * FROM DONVI;
SELECT * FROM NHANVIEN;
SELECT * FROM SINHVIEN;
SELECT * FROM HOCPHAN;
SELECT * FROM MOMON;
SELECT * FROM DANGKY;
SELECT * FROM THONGBAO;